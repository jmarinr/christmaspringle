<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Christmas Pringle - Admin Panel Pro</title>
<link rel="icon" type="image/png" href="christmas-pringle-logo.png">
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Mountains+of+Christmas:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{box-sizing:border-box} :root{
    --primary-red:#E74C3C;--primary-green:#00C853;--primary-blue:#039BE5;--primary-gold:#FFB300;
    --text-dark:#263238;--text-light:#546E7A;--bg:#F5F9FC;--border:#E0E0E0;
  }
  html,body{height:100%}
  body{font-family:'Google Sans',system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);margin:0;padding:24px}

  /* ---------- Login Overlay ---------- */
  .login-wrap{max-width:460px;margin:4rem auto;background:#fff;border-radius:20px;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .login-title{font-family:'Mountains of Christmas',cursive;color:var(--primary-red);font-size:2.2em;text-align:center;margin:0 0 .5rem}
  .login-sub{color:var(--text-light);text-align:center;margin-bottom:1rem}
  .login-row{display:flex;flex-direction:column;gap:.5rem;margin:.8rem 0}
  .field{position:relative}
  .field input{width:100%;padding:12px 44px 12px 14px;border:2px solid var(--border);border-radius:12px;font-size:16px}
  .field input:focus{outline:none;border-color:var(--primary-blue)}
  .toggle-pass{position:absolute;right:8px;top:8px;border:0;background:transparent;font-size:1.1rem;cursor:pointer;color:#607D8B}
  .btn-primary{background:linear-gradient(135deg,var(--primary-red),#c0392b);color:#fff;border:0;border-radius:999px;padding:12px 18px;font-weight:700;cursor:pointer}
  .btn-ghost{background:#fff;border:2px solid var(--border);border-radius:999px;padding:10px 16px;font-weight:600;color:var(--text-dark);cursor:pointer}
  .login-actions{display:flex;gap:.6rem;justify-content:center;margin-top:4px}
  .login-error{display:none;margin-top:.6rem;background:#FFEBEE;color:#B71C1C;border-radius:12px;padding:.6rem .8rem;font-weight:600;text-align:center}

  /* ---------- App Container ---------- */
  .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:24px;padding:28px;box-shadow:0 20px 60px rgba(0,0,0,.30);display:none}
  .header{display:flex;flex-direction:column;align-items:center;gap:.75rem;margin-bottom:16px}
  .header h1{font-family:'Mountains of Christmas',cursive;color:var(--primary-red);font-size:2.6em;margin:0}
  .badge{display:inline-block;background:linear-gradient(135deg,var(--primary-gold),#FDD835);color:var(--text-dark);padding:.45rem 1.1rem;border-radius:999px;font-weight:700;font-size:.95em}
  .sub{color:var(--text-light);text-align:center;margin:.4rem 0 1rem}

  /* ---------- Topbar (PAT + acciones) ---------- */
  .topbar{position:static;margin:.25rem 0 0;display:flex;align-items:center;justify-content:center;gap:.6rem;flex-wrap:wrap}
  .chip{display:flex;align-items:center;gap:.5rem;background:#F3F6FB;border:2px solid #dfe7f2;padding:.45rem .8rem;border-radius:999px;color:#2c3e50;font-weight:700;max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .chip i{opacity:.75}
  .ok{color:#1B5E20}
  .warn{color:#B71C1C}
  #copyPatBtn,#logoutBtn{border-radius:999px;padding:.6rem .9rem;border:2px solid var(--border);background:#fff;font-weight:700;cursor:pointer}
  #logoutBtn{border-color:#ffcdd2;color:#B71C1C}

  /* ---------- Grid de tarjetas ---------- */
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:10px}
  .card{background:linear-gradient(180deg,#e3f2fd,#cfe8ff);border-radius:18px;padding:16px;border:2px solid #bbd8ff}
  .card h3{margin:.2rem 0 .6rem;color:#0d47a1}
  .upload-area{border:3px dashed var(--primary-blue);border-radius:16px;padding:18px;text-align:center;background:#fff;cursor:pointer;transition:.25s;margin-bottom:12px}
  .upload-area:hover{border-color:var(--primary-red);background:#FFF5F5;transform:translateY(-2px)}
  .upload-icon{font-size:2.2em;color:var(--primary-blue);margin-bottom:.3rem}
  .preview-image{width:100%;height:190px;object-fit:cover;border-radius:12px;margin-top:.5rem;display:none}
  .row{display:flex;flex-direction:column;gap:.35rem;margin:.55rem 0}
  label{font-weight:700;color:#0d47a1}
  input[type="text"],input[type="number"],textarea{width:100%;padding:.75rem;border:2px solid var(--border);border-radius:10px;font-size:15px}
  input:focus,textarea:focus{outline:none;border-color:var(--primary-blue)}
  textarea{min-height:100px;resize:vertical}
  .btn{display:inline-flex;align-items:center;gap:.5rem;border:0;border-radius:999px;padding:.9rem 1.2rem;font-weight:800;cursor:pointer}
  .btn-red{background:linear-gradient(135deg,#d84315,#e53935);color:#fff}
  .btn-blue{background:#fff;border:2px solid #d1e3ff;color:#0d47a1}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .actions{display:flex;gap:.6rem;flex-wrap:wrap}

  /* ---------- Saved list ---------- */
  .list{margin-top:22px;background:#F8F9FA;padding:16px;border-radius:16px}
  .list h2{font-family:'Mountains of Christmas',cursive;margin:0 0 10px;color:#263238}
  .saved-card{background:#fff;padding:12px;border-radius:12px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:grid;grid-template-columns:90px 1fr auto;gap:10px;align-items:center}
  .saved-card img{width:90px;height:90px;object-fit:cover;border-radius:8px}
  .saved-card .price{color:var(--primary-gold);font-weight:800}

  /* ---------- Toasts ---------- */
  .toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .toast{background:#fff;border-left:6px solid var(--primary-blue);box-shadow:0 8px 24px rgba(0,0,0,.18);padding:.8rem 1rem;border-radius:12px;min-width:280px;font-weight:600;color:#2c3e50}
  .toast.success{border-left-color:#00C853}
  .toast.error{border-left-color:#E53935}
  .toast.info{border-left-color:#039BE5}

  /* ---------- Modal ---------- */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9998}
  .modal{background:#fff;border-radius:16px;max-width:520px;width:92vw;padding:18px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .modal h4{margin:0 0 .6rem}
  .modal .modal-actions{display:flex;gap:.6rem;justify-content:flex-end;margin-top:10px}

  /* ---------- RESPONSIVE ---------- */
  @media (max-width:1200px){
    .container{padding:20px}
    .grid{grid-template-columns:repeat(2,1fr);gap:14px}
    .header h1{font-size:2.2em}
    .saved-card{grid-template-columns:80px 1fr auto}
    .saved-card img{width:80px;height:80px}
  }
  @media (max-width:900px){
    body{padding:16px}
    .container{padding:16px;border-radius:18px}
    .grid{grid-template-columns:1fr;gap:12px}
    .preview-image{height:170px}
    .btn{width:100%;justify-content:center}
    .list{padding:12px}
    .saved-card{grid-template-columns:70px 1fr}
    .saved-card img{width:70px;height:70px}
  }
  @media (max-width:640px){
    .header h1{font-size:1.9em}
    .chip{max-width:240px}
    input[type="text"],input[type="password"],input[type="number"],textarea{font-size:16px}
    .preview-image{height:150px}
    .toasts{left:0;right:0;align-items:center}
    .toast{width:calc(100% - 24px);max-width:520px}
  }
  @media (min-width:1400px){
    .topbar{justify-content:flex-end;align-self:stretch;padding:.25rem 0 0}
  }
  @media (prefers-reduced-motion:reduce){
    *{animation-duration:.01ms !important;animation-iteration-count:1 !important;transition-duration:.01ms !important}
  }
</style>
</head>
<body>

<!-- ========== LOGIN ========== -->
<div id="loginView" class="login-wrap">
  <h1 class="login-title">Panel de Administraci√≥n</h1>
  <p class="login-sub">Acceso exclusivo</p>

  <div class="login-row">
    <label>Usuario</label>
    <div class="field">
      <input id="loginUser" type="text" placeholder="Usuario" autocomplete="username">
    </div>
  </div>

  <div class="login-row">
    <label>Contrase√±a</label>
    <div class="field">
      <input id="loginPass" type="password" placeholder="Contrase√±a" autocomplete="current-password">
      <button class="toggle-pass" type="button" id="togglePassBtn" aria-label="Ver contrase√±a"><i class="fa-regular fa-eye"></i></button>
    </div>
  </div>

  <div class="login-row">
    <label>Token</label>
    <div class="field">
      <input id="loginPAT" type="text" placeholder="ghp_..." autocomplete="off">
    </div>
  </div>

  <div id="loginError" class="login-error">Credenciales inv√°lidas o PAT vac√≠o.</div>

  <div class="login-actions">
    <button id="loginBtn" class="btn-primary"><i class="fa-solid fa-right-to-bracket"></i> Ingresar</button>
    <a href="index.html" class="btn-ghost"><i class="fa-solid fa-home"></i> Ir al sitio</a>
  </div>
</div>

<!-- ========== APP ========== -->
<div id="app" class="container">
  <div class="header">
    <h1>üé® Panel de Administraci√≥n PRO</h1>
    <span class="badge"><i class="fas fa-bolt"></i> Gesti√≥n de Tarjetas</span>
    <div class="topbar">
      <span id="patChip" class="chip"><i class="fa-solid fa-key"></i> PAT: <span id="patStatus" class="warn">faltante</span></span>
      <button id="copyPatBtn" class="btn-ghost"><i class="fa-regular fa-copy"></i> Copiar</button>
      <button id="logoutBtn" class="btn-ghost"><i class="fa-solid fa-arrow-right-from-bracket"></i> Cerrar sesi√≥n</button>
    </div>
    <p class="sub">Carga hasta 10 tarjetas navide√±as con t√≠tulo, descripci√≥n y precio</p>
  </div>

  <div id="cardsContainer" class="grid"></div>

  <div class="list">
    <h2>üìã Tarjetas Guardadas</h2>
    <div id="savedCardsList"></div>
  </div>
</div>

<!-- Toasts & Modal -->
<div class="toasts" id="toasts"></div>
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal">
    <h4 id="modalTitle">Confirmar</h4>
    <div id="modalBody">¬øDeseas continuar?</div>
    <div class="modal-actions">
      <button id="modalCancel" class="btn btn-blue"><i class="fa-regular fa-circle-xmark"></i> Cancelar</button>
      <button id="modalOk" class="btn btn-red"><i class="fa-solid fa-check"></i> Aceptar</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Estado / Config
========================= */
const GITHUB = {
  username: 'jmarinr',
  repo: 'christmaspringle',
  branch: 'main'
};
const MAX_CARDS = 10;
let cardsData = [];
let pendingAction = null; // para modal

/* =========================
   Utilidades UI
========================= */
const $ = (q)=>document.querySelector(q);
const toasts = $("#toasts");
function toast(msg, type='info', timeout=3000){
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  toasts.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; setTimeout(()=>el.remove(),300); }, timeout);
}
function showModal(title, body, onOk){
  $("#modalTitle").textContent = title;
  $("#modalBody").textContent = body;
  $("#modalBackdrop").style.display = 'flex';
  pendingAction = onOk || null;
}
function hideModal(){
  $("#modalBackdrop").style.display = 'none';
  pendingAction = null;
}
$("#modalCancel").addEventListener('click', hideModal);
$("#modalOk").addEventListener('click', ()=>{ if(pendingAction) pendingAction(); hideModal(); });

/* =========================
   Login
========================= */
const loginView = $("#loginView");
const app = $("#app");
const loginUser = $("#loginUser");
const loginPass = $("#loginPass");
const loginPAT  = $("#loginPAT");
const loginError= $("#loginError");
const togglePassBtn = $("#togglePassBtn");

togglePassBtn.addEventListener('click',()=>{
  const t = loginPass.type === 'password' ? 'text':'password';
  loginPass.type = t;
  togglePassBtn.innerHTML = (t==='password')
    ? '<i class="fa-regular fa-eye"></i>' : '<i class="fa-regular fa-eye-slash"></i>';
});

function isLogged(){
  return localStorage.getItem('cp_logged') === '1';
}
function getPAT(){
  return localStorage.getItem('cp_pat') || '';
}
function setPAT(token){
  localStorage.setItem('cp_pat', token||'');
  updatePatChip();
}
function updatePatChip(){
  const pat = getPAT();
  const status = $("#patStatus");
  const chip = $("#patChip");
  if (pat && pat.startsWith('gh')){
    status.textContent = 'ok';
    status.classList.remove('warn'); status.classList.add('ok');
    chip.title = pat;
  }else{
    status.textContent = 'faltante';
    status.classList.add('warn'); status.classList.remove('ok');
    chip.title = '';
  }
}
function showApp(){
  loginView.style.display = 'none';
  app.style.display = 'block';
  updatePatChip();
  renderCardForms();
  renderSavedCards();
}
function showLogin(){
  app.style.display = 'none';
  loginView.style.display = 'block';
}

$("#loginBtn").addEventListener('click', ()=>{
  const u = (loginUser.value||'').trim();
  const p = (loginPass.value||'').trim();
  const t = (loginPAT.value||'').trim();
  if (u==='patripringle' && p==='SoyPatri1978' && t){
    localStorage.setItem('cp_logged','1');
    setPAT(t);
    loginError.style.display='none';
    showApp();
    toast('¬°Bienvenido!', 'success');
  } else {
    loginError.style.display='block';
  }
});

/* Sesi√≥n persistente */
window.addEventListener('load', ()=>{
  if(isLogged()){
    const storedPAT = getPAT();
    if(!storedPAT) showLogin(); else showApp();
  }else{
    showLogin();
  }
});

/* Copy / Logout */
$("#copyPatBtn").addEventListener('click', async ()=>{
  const pat = getPAT();
  if(!pat) return toast('No hay PAT guardado.','error');
  try{ await navigator.clipboard.writeText(pat); toast('PAT copiado.','success'); }
  catch{ toast('No se pudo copiar.','error'); }
});
$("#logoutBtn").addEventListener('click', ()=>{
  showModal('Cerrar sesi√≥n','¬øSeguro que deseas salir?', ()=>{
    localStorage.removeItem('cp_logged');
    localStorage.removeItem('cp_pat');
    showLogin();
  });
});

/* =========================
   Render Tarjetas
========================= */
function renderCardForms(){
  const container = $("#cardsContainer");
  container.innerHTML = '';
  for(let i=1;i<=MAX_CARDS;i++){
    const existing = cardsData.find(c=>c.number===i);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <h3>‚ùÑ Tarjeta #${i}</h3>
      <div class="upload-area" id="uploadArea${i}">
        <div class="upload-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
        <div>PNG, JPG, JPEG (M√°x: 5MB)</div>
        <input type="file" id="fileInput${i}" accept="image/png,image/jpeg,image/jpg" style="display:none">
        <img id="preview${i}" class="preview-image" alt="Vista previa">
      </div>

      <div class="row">
        <label for="title${i}">T√≠tulo</label>
        <input type="text" id="title${i}" placeholder="Ej: √Årbol de Esperanza" value="${existing?escapeHtml(existing.title):''}">
      </div>

      <div class="row">
        <label for="description${i}">Descripci√≥n</label>
        <textarea id="description${i}" placeholder="Describe tu tarjeta navide√±a...">${existing?escapeHtml(existing.description):''}</textarea>
      </div>

      <div class="row">
        <label for="price${i}">Precio (USD)</label>
        <input type="number" id="price${i}" placeholder="15.00" step="0.01" min="0" value="${existing?existing.price:''}">
      </div>

      <div class="actions">
        <button class="btn btn-red" id="uploadBtn${i}"><i class="fa-solid fa-cloud-arrow-up"></i> Subir #${i}</button>
        <button class="btn btn-blue" id="clearBtn${i}"><i class="fa-regular fa-broom"></i> Limpiar</button>
      </div>
      <div id="status${i}" class="status"></div>
    `;
    container.appendChild(card);
    setupCardHandlers(i, existing);
  }
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));}
function setupCardHandlers(n, existing){
  const uploadArea = $(`#uploadArea${n}`);
  const fileInput  = $(`#fileInput${n}`);
  const preview    = $(`#preview${n}`);
  const title      = $(`#title${n}`);
  const desc       = $(`#description${n}`);
  const price      = $(`#price${n}`);
  const uploadBtn  = $(`#uploadBtn${n}`);
  const clearBtn   = $(`#clearBtn${n}`);

  if(existing){
    preview.src = rawImageUrl(existing.image);
    preview.style.display='block';
  }

  uploadArea.addEventListener('click', ()=>fileInput.click());
  fileInput.addEventListener('change',(e)=>{
    const file = e.target.files[0];
    if(!file) return;
    if(file.size > 5*1024*1024) return toast('La imagen debe ser menor a 5MB','error');
    const rd = new FileReader();
    rd.onload = (ev)=>{ preview.src = ev.target.result; preview.style.display='block'; };
    rd.readAsDataURL(file);
  });

  clearBtn.addEventListener('click', ()=>{
    fileInput.value=''; preview.style.display='none';
    title.value=''; desc.value=''; price.value='';
  });

  uploadBtn.addEventListener('click', ()=>uploadCard(n));
}

/* =========================
   GitHub API helpers
========================= */
function rawImageUrl(filename){
  const t = Date.now();
  return `https://raw.githubusercontent.com/${GITHUB.username}/${GITHUB.repo}/${GITHUB.branch}/${filename}?t=${t}`;
}

async function githubGet(url){
  const pat = getPAT();
  const res = await fetch(url,{ headers:{
    'Authorization': `token ${pat}`,
    'Accept':'application/vnd.github.v3+json'
  }});
  return res;
}
async function githubPut(url, body){
  const pat = getPAT();
  const res = await fetch(url,{ method:'PUT', headers:{
    'Authorization': `token ${pat}`,
    'Accept':'application/vnd.github.v3+json',
    'Content-Type':'application/json'
  }, body: JSON.stringify(body)});
  return res;
}
async function githubDelete(url, body){
  const pat = getPAT();
  const res = await fetch(url,{ method:'DELETE', headers:{
    'Authorization': `token ${pat}`,
    'Accept':'application/vnd.github.v3+json',
    'Content-Type':'application/json'
  }, body: JSON.stringify(body)});
  return res;
}

/* =========================
   Carga inicial de cards.json (si existe en repo)
========================= */
async function fetchCardsJson(){
  try{
    const url = `https://raw.githubusercontent.com/${GITHUB.username}/${GITHUB.repo}/${GITHUB.branch}/cards.json?t=${Date.now()}`;
    const res = await fetch(url,{cache:'no-store'});
    if(!res.ok) return;
    const text = await res.text();
    const data = JSON.parse(text);
    if(Array.isArray(data)){ cardsData = data; }
  }catch(e){ /* ignora si no existe */ }
}
window.addEventListener('load', async ()=>{
  await fetchCardsJson();
});

/* =========================
   Subir tarjeta
========================= */
async function uploadCard(n){
  const pat = getPAT();
  if(!pat){ toast('Agrega el PAT en la sesi√≥n.','error'); return; }

  const fileInput = $(`#fileInput${n}`);
  const title = $(`#title${n}`).value.trim();
  const description = $(`#description${n}`).value.trim();
  const price = parseFloat($(`#price${n}`).value);
  if(!fileInput.files[0] || !title || !description || !(price>0)){
    return toast('Completa imagen, t√≠tulo, descripci√≥n y precio.','error');
  }

  try{
    const file = fileInput.files[0];
    const fileName = `${n}.png`;
    const imageData = await convertToPNG(file);
    const base64Data = await blobToBase64(imageData);

    await uploadFileToGithub(fileName, base64Data);

    const idx = cardsData.findIndex(c=>c.number===n);
    const cardData = { number:n, title, description, price, image:fileName, uploadedAt:new Date().toISOString() };
    if(idx>=0) cardsData[idx]=cardData; else cardsData.push(cardData);
    cardsData.sort((a,b)=>a.number-b.number);
    await updateCardsJSON();
    toast(`Tarjeta #${n} subida.`, 'success');

    // refresco preview
    const preview = $(`#preview${n}`);
    preview.src = rawImageUrl(fileName);
    preview.style.display='block';
    renderSavedCards();

  }catch(err){
    if(String(err.message||'').includes('Bad credentials')){
      toast('Error de autenticaci√≥n con GitHub (revisa PAT).','error');
    }else{
      toast(`Error: ${err.message||err}`, 'error', 5000);
    }
  }
}

async function updateCardsJSON(){
  const json = JSON.stringify(cardsData, null, 2);
  const base64 = btoa(unescape(encodeURIComponent(json)));
  const url = `https://api.github.com/repos/${GITHUB.username}/${GITHUB.repo}/contents/cards.json`;

  // obtener sha si existe
  let sha=null;
  const check = await githubGet(url);
  if(check.ok){ const d = await check.json(); sha=d.sha; }

  const body = { message:`Update cards data - ${cardsData.length} cards`, content:base64, branch:GITHUB.branch };
  if(sha) body.sha = sha;

  const res = await githubPut(url, body);
  if(!res.ok){
    let e = await res.json().catch(()=>({message:'Error al actualizar cards.json'}));
    throw new Error(e.message||'Error al actualizar cards.json');
  }
}

async function uploadFileToGithub(fileName, base64Content){
  const url = `https://api.github.com/repos/${GITHUB.username}/${GITHUB.repo}/contents/${fileName}`;

  // sha si existe
  let sha=null;
  const check = await githubGet(url);
  if(check.ok){ const d=await check.json(); sha=d.sha; }

  const body = { message:`Upload ${fileName} via Admin`, content: base64Content.split(',')[1], branch:GITHUB.branch };
  if(sha) body.sha = sha;

  const res = await githubPut(url, body);
  if(!res.ok){
    let e = await res.json().catch(()=>({message:'Error al subir imagen'}));
    throw new Error(e.message||'Error al subir imagen');
  }
}

/* Conversi√≥n y base64 */
function convertToPNG(file){
  return new Promise((resolve)=>{
    const r = new FileReader();
    r.onload = (e)=>{
      const img = new Image();
      img.onload = ()=>{
        const canvas = document.createElement('canvas');
        canvas.width = img.width; canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img,0,0);
        canvas.toBlob((blob)=>resolve(blob),'image/png');
      };
      img.src = e.target.result;
    };
    r.readAsDataURL(file);
  });
}
function blobToBase64(blob){
  return new Promise((resolve)=>{
    const r = new FileReader();
    r.onloadend = ()=>resolve(r.result);
    r.readAsDataURL(blob);
  });
}

/* =========================
   Guardadas y eliminar
========================= */
function renderSavedCards(){
  const container = $("#savedCardsList");
  if(!cardsData.length){
    container.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:1rem">No hay tarjetas guardadas a√∫n</p>';
    return;
  }
  cardsData.sort((a,b)=>a.number-b.number);
  container.innerHTML = cardsData.map(c=>`
    <div class="saved-card">
      <img src="${rawImageUrl(c.image)}" alt="${escapeHtml(c.title)}">
      <div>
        <div style="font-weight:800;color:#263238">#${c.number} - ${escapeHtml(c.title)}</div>
        <div style="color:#546E7A">${escapeHtml(c.description)}</div>
        <div class="price">$${Number(c.price).toFixed(2)}</div>
        <div style="font-size:.85em;opacity:.7">Actualizado: ${new Date(c.uploadedAt).toLocaleString()}</div>
      </div>
      <button class="btn btn-red" onclick="confirmDelete(${c.number})"><i class="fa-regular fa-trash-can"></i></button>
    </div>
  `).join('');
}

function confirmDelete(n){
  showModal('Eliminar tarjeta',`¬øEliminar la tarjeta #${n}?`, ()=>deleteCard(n));
}

async function deleteCard(n){
  try{
    const card = cardsData.find(c=>c.number===n);
    if(!card) return;

    // borrar imagen si existe
    const url = `https://api.github.com/repos/${GITHUB.username}/${GITHUB.repo}/contents/${card.image}`;
    const check = await githubGet(url);
    if(check.ok){
      const data = await check.json();
      await githubDelete(url, { message:`Delete ${card.image}`, sha:data.sha, branch:GITHUB.branch });
    }

    // quitar local y actualizar cards.json
    cardsData = cardsData.filter(c=>c.number!==n);
    await updateCardsJSON();
    renderSavedCards();
    // limpiar formulario visual
    const fileInput = $(`#fileInput${n}`);
    const preview = $(`#preview${n}`);
    const title = $(`#title${n}`), desc=$(`#description${n}`), price=$(`#price${n}`);
    if(fileInput){ fileInput.value=''; }
    if(preview){ preview.style.display='none'; }
    if(title) title.value=''; if(desc) desc.value=''; if(price) price.value='';
    toast(`Tarjeta #${n} eliminada.`, 'success');
  }catch(err){
    toast(`Error al eliminar: ${err.message||err}`, 'error');
  }
}
</script>
</body>
</html>
