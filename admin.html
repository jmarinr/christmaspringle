<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Administración · Christmas Pringle</title>
<link rel="icon" type="image/png" href="christmas-pringle-logo.png">
<link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --bg:#0f172a; --panel:#111827; --panel-2:#0b1220; --text:#e5e7eb; --muted:#9ca3af;
  --acc:#22c55e; --danger:#ef4444; --warn:#f59e0b; --info:#38bdf8;
  --gold:#fbbf24; --border:#1f2937; --chip:#1f2937;
  --green-grad:linear-gradient(135deg,#00C853,#69F0AE);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Google Sans',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
  background:linear-gradient(180deg,#0b1220,#0e1526 60%,#0b1220);
  color:var(--text);
}

/* Topbar */
.topbar{position:sticky; top:0; z-index:10; background:#0c1424cc; backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);}
.topbar-inner{max-width:1200px; margin:0 auto; padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
.brand{display:flex; align-items:center; gap:10px}
.brand img{height:36px; width:auto; border-radius:8px}
.badge{background:#122038; color:#d1d5db; padding:6px 10px; border-radius:999px; font-size:.85rem; border:1px solid var(--border)}
.actions{display:flex; gap:8px}
.btn{display:inline-flex; align-items:center; gap:.5rem; padding:.6rem .9rem; border-radius:10px; border:1px solid var(--border); background:#0f1a2b; color:#e5e7eb; cursor:pointer; transition:.2s}
.btn:hover{filter:brightness(1.08)}
.btn-green{background:#0f2a1a; border-color:#174a2a}
.btn-red{background:#2a0f13; border-color:#4a1720}
.btn-gold{background:#2a230f; border-color:#4a3a17}

/* Layout */
.wrap{max-width:1200px; margin:20px auto; padding:0 16px}
.panel{background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
.panel-header{display:flex; align-items:center; justify-content:space-between; padding:16px; border-bottom:1px solid var(--border)}
.panel-body{padding:16px}

/* Login */
.login{max-width:420px; margin:10vh auto; padding:24px; background:var(--panel); border:1px solid var(--border); border-radius:16px}
.login h1{font-size:1.4rem; margin-bottom:12px}
.field{display:grid; gap:6px; margin-bottom:12px}
label{color:#cbd5e1; font-weight:600}
input[type="text"], input[type="password"], input[type="number"], textarea{
  background:#0b1220; border:1px solid #1f2937; color:#e5e7eb; border-radius:10px; padding:.75rem .85rem;
}
textarea{min-height:100px; resize:vertical}
.helper{font-size:.85rem; color:#94a3b8}

/* Grid formulario + lista */
.grid{display:grid; grid-template-columns:1.1fr .9fr; gap:18px}
@media (max-width:980px){ .grid{grid-template-columns:1fr} }

/* Uploader doble */
.uploader{display:grid; grid-template-columns:1fr 1fr; gap:12px}
.up-card{background:var(--panel-2); border:1px solid var(--border); border-radius:12px; padding:12px}
.up-card h4{margin-bottom:8px}
.drop{position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:8px; min-height:180px; border:2px dashed #334155; border-radius:12px; padding:10px; cursor:pointer; text-align:center}
.drop input{position:absolute; inset:0; opacity:0; cursor:pointer}
.preview{width:100%; aspect-ratio:4/3; border-radius:8px; overflow:hidden; background:#0b1220; display:flex; align-items:center; justify-content:center}
.preview img{width:100%; height:100%; object-fit:contain}
.meta{font-size:.82rem; color:#94a3b8}

/* Lista tarjetas */
.cards{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px}
.card{background:#0b1220; border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column}
.card .thumbs{display:grid; grid-template-columns:1fr 1fr; gap:2px; background:#050a14}
.card .thumbs img{width:100%; height:140px; object-fit:cover}
.card .content{padding:12px; display:grid; gap:6px}
.tag{display:inline-flex; align-items:center; gap:.4rem; font-weight:700; font-size:.85rem; background:#172036; padding:.35rem .6rem; border-radius:999px}
.card .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
.card .title{font-weight:700}
.card .actions{margin-top:6px; display:flex; gap:8px}
.small{font-size:.9rem}

/* Toasts */
.toast{position:fixed; right:16px; bottom:16px; display:grid; gap:8px; z-index:99}
.toast .t{background:#0f1a2b; border:1px solid var(--border); color:#e5e7eb; padding:.7rem .9rem; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.35)}
.toast .ok{border-left:4px solid #22c55e}
.toast .err{border-left:4px solid #ef4444}
.toast .inf{border-left:4px solid #38bdf8}

/* Modal confirm */
.modal{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:50}
.modal.open{display:flex}
.modal .box{background:#0f1a2b; border:1px solid var(--border); color:#e5e7eb; width:min(520px,92vw); border-radius:14px; padding:16px}
.modal .box h3{margin-bottom:8px}
.modal .box .row{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
.code{font-family:ui-monospace,Menlo,Consolas,monospace; font-size:.9rem; color:#93c5fd}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <img src="christmas-pringle-logo.png" alt="Logo">
      <span class="badge">Admin · Christmas Pringle</span>
    </div>
    <div class="actions">
      <button id="copyPatBtn" class="btn"><i class="fa-regular fa-copy"></i> Copiar PAT</button>
      <button id="logoutBtn" class="btn btn-red"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- Login -->
  <div id="loginBox" class="login" style="display:none">
    <h1>Iniciar sesión</h1>
    <div class="field">
      <label for="user">Usuario</label>
      <input id="user" type="text" autocomplete="username" placeholder="Usuario" value="">
    </div>
    <div class="field">
      <label for="pass">Contraseña</label>
      <input id="pass" type="password" autocomplete="current-password" placeholder="Contraseña">
    </div>
    <div class="field">
      <label for="pat">Token de GitHub (PAT)</label>
      <input id="pat" type="text" placeholder="ghp_..." />
      <div class="helper">Se guarda de forma local segura como <code>cp_pat</code>. Permisos: <b>repo</b> (contenido).</div>
    </div>
    <button id="loginBtn" class="btn btn-green" style="width:100%;justify-content:center"><i class="fa-solid fa-unlock"></i> Entrar</button>
  </div>

  <!-- Panel -->
  <div id="adminPanel" class="panel" style="display:none">
    <div class="panel-header">
      <div>
        <strong>Nueva / Editar Tarjeta</strong>
        <div class="helper">Sube <b>dos fotos</b> por tarjeta: <u>frente</u> y <u>adentro</u>. Se guardan en GitHub y se actualiza <code>cards.json</code>.</div>
      </div>
      <div id="patChip" class="badge">PAT: <span id="patShort">—</span></div>
    </div>

    <div class="panel-body">
      <div class="grid">
        <!-- Formulario -->
        <div>
          <div class="field">
            <label for="number">Número (único)</label>
            <input id="number" type="number" min="1" step="1" placeholder="Ej. 1">
          </div>
          <div class="field">
            <label for="title">Título</label>
            <input id="title" type="text" placeholder="Ej. Copo de nieve en acuarela">
          </div>
          <div class="field">
            <label for="desc">Descripción</label>
            <textarea id="desc" placeholder="Detalle breve de la tarjeta"></textarea>
          </div>
          <div class="field">
            <label for="price">Precio (₡ colones)</label>
            <input id="price" type="number" min="0" step="1" placeholder="Ej. 3500">
          </div>

          <div class="uploader">
            <!-- Frente -->
            <div class="up-card">
              <h4>Foto Frente</h4>
              <div class="drop" id="dropFront">
                <input type="file" id="fileFront" accept="image/*">
                <div class="preview" id="prevFront"><span class="meta">Arrastra o haz click para cargar</span></div>
                <div class="meta small" id="metaFront">Sin archivo</div>
              </div>
            </div>
            <!-- Adentro -->
            <div class="up-card">
              <h4>Foto Adentro</h4>
              <div class="drop" id="dropInside">
                <input type="file" id="fileInside" accept="image/*">
                <div class="preview" id="prevInside"><span class="meta">Arrastra o haz click para cargar</span></div>
                <div class="meta small" id="metaInside">Sin archivo</div>
              </div>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:14px">
            <button id="saveBtn" class="btn btn-green"><i class="fa-solid fa-floppy-disk"></i> Guardar / Actualizar</button>
            <button id="resetBtn" class="btn"><i class="fa-solid fa-rotate-left"></i> Limpiar</button>
          </div>
        </div>

        <!-- Lista -->
        <div>
          <div class="row" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px">
            <strong>Tarjetas guardadas</strong>
            <button id="refreshBtn" class="btn"><i class="fa-solid fa-rotate"></i> Actualizar</button>
          </div>
          <div id="cardsList" class="cards"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal eliminar -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-label="Confirmar acción">
  <div class="box">
    <h3>¿Eliminar tarjeta?</h3>
    <div class="helper">Esta acción eliminará la tarjeta del <code>cards.json</code> y también intentará borrar ambas imágenes (frente y adentro) del repositorio.</div>
    <div id="modalInfo" class="code" style="margin-top:8px"></div>
    <div class="row">
      <button id="cancelDel" class="btn">Cancelar</button>
      <button id="confirmDel" class="btn btn-red"><i class="fa-solid fa-trash"></i> Eliminar</button>
    </div>
  </div>
</div>

<!-- Toasts -->
<div id="toast" class="toast" aria-live="polite"></div>

<script>
/* ====== Config GitHub ====== */
const GH = {
  owner: 'jmarinr',
  repo: 'christmaspringle',
  branch: 'main',
  cardsJsonPath: 'cards.json',
  imagesDir: 'images/cards'
};

/* ====== Utils ====== */
const $ = (s, p=document) => p.querySelector(s);
const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
const fmtCRC = n => '₡'+Math.round(Number(n||0)).toLocaleString('es-CR');

function toast(msg, type='inf'){
  const box = $('#toast');
  const t = document.createElement('div');
  t.className = 't '+(type==='ok'?'ok':type==='err'?'err':'inf');
  t.textContent = msg;
  box.appendChild(t);
  setTimeout(()=>{ t.style.opacity='.0'; t.style.transform='translateY(6px)';}, 2500);
  setTimeout(()=>{ t.remove(); }, 3000);
}

function shortPat(token){
  if(!token) return '—';
  const head = token.slice(0,4);
  const tail = token.slice(-4);
  return head+'…'+tail;
}

function fileExt(file){
  const name = (file?.name||'').toLowerCase();
  const fromName = name.includes('.') ? name.split('.').pop() : '';
  const fromType = (file?.type||'').split('/').pop();
  const ext = fromName || fromType || 'jpg';
  return ext.replace(/[^a-z0-9]/g,'') || 'jpg';
}

function readAsDataURL(file){
  return new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}

function dataURLtoBase64(dataURL){
  return dataURL.split(',')[1]; // quitar "data:image/...;base64,"
}

/* ====== Estado sesión ====== */
const loginBox = $('#loginBox');
const adminPanel = $('#adminPanel');
const patChip = $('#patChip');
const patShort = $('#patShort');

function showLogin(){ loginBox.style.display='block'; adminPanel.style.display='none'; }
function showAdmin(){ loginBox.style.display='none'; adminPanel.style.display='block'; }

function checkSession(){
  const ok = localStorage.getItem('cp_logged')==='1';
  const pat = localStorage.getItem('cp_pat')||'';
  if(ok){ showAdmin(); patShort.textContent = shortPat(pat); }
  else { showLogin(); }
}
checkSession();

/* ====== Login ====== */
$('#loginBtn')?.addEventListener('click', ()=>{
  const u = $('#user').value.trim();
  const p = $('#pass').value.trim();
  const t = $('#pat').value.trim();
  if(u!=='patripringle' || p!=='SoyPatri1978'){ toast('Usuario o contraseña incorrectos','err'); return; }
  if(!t){ toast('Ingresa tu token de GitHub (PAT)','err'); return; }
  localStorage.setItem('cp_logged','1');
  localStorage.setItem('cp_pat', t);
  toast('Bienvenida, Patri ✨','ok');
  showAdmin();
  patShort.textContent = shortPat(t);
});

$('#logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('cp_logged');
  // Mantengo PAT para no volver a pegarlo cada vez; si prefieres borrarlo, descomenta:
  // localStorage.removeItem('cp_pat');
  toast('Sesión cerrada','ok');
  showLogin();
});

$('#copyPatBtn').addEventListener('click', async ()=>{
  const pat = localStorage.getItem('cp_pat')||'';
  if(!pat){ toast('No hay PAT guardado','err'); return; }
  await navigator.clipboard.writeText(pat);
  toast('PAT copiado','ok');
});

/* ====== GitHub API wrappers ====== */
function ghHeaders(){
  const pat = localStorage.getItem('cp_pat')||'';
  return { 'Authorization':'Bearer '+pat, 'Accept':'application/vnd.github+json' };
}

async function ghGet(path){
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}?ref=${GH.branch}`;
  const r = await fetch(url, {headers: ghHeaders()});
  if(r.status===404) return null;
  if(!r.ok) throw new Error('GET '+path+' -> '+r.status);
  return r.json();
}

async function ghPut(path, base64Content, message, sha){
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}`;
  const body = {
    message, content: base64Content, branch: GH.branch
  };
  if(sha) body.sha = sha;
  const r = await fetch(url, {method:'PUT', headers: {...ghHeaders(),'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(!r.ok) throw new Error('PUT '+path+' -> '+r.status+' '+(await r.text()));
  return r.json();
}

async function ghDelete(path, message, sha){
  const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}`;
  const body = { message, sha, branch: GH.branch };
  const r = await fetch(url, {method:'DELETE', headers: {...ghHeaders(),'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(!r.ok) throw new Error('DELETE '+path+' -> '+r.status+' '+(await r.text()));
  return r.json();
}

/* ====== Cargar y renderizar cards.json ====== */
let CARDS = []; // estado en memoria
let cardsJsonSha = null;

async function loadCardsJson(){
  const f = await ghGet(GH.cardsJsonPath);
  if(!f){ CARDS = []; cardsJsonSha = null; return; }
  cardsJsonSha = f.sha;
  const content = atob(f.content.replace(/\n/g,''));
  try{
    const raw = JSON.parse(content);
    CARDS = Array.isArray(raw) ? raw : [];
  }catch(e){
    CARDS = [];
  }
  // Back-compat: asegurar campos
  CARDS = CARDS.map(c=>({
    number: c.number,
    title: c.title || '',
    description: c.description || '',
    price: c.price ?? 0,
    image: c.image || '',               // frente (compat index actual)
    image_inside: c.image_inside || ''  // NUEVO
  })).sort((a,b)=> (a.number||0)-(b.number||0));
}

function renderCards(){
  const list = $('#cardsList');
  if(!CARDS.length){
    list.innerHTML = `<div class="helper">No hay tarjetas aún.</div>`;
    return;
  }
  list.innerHTML = CARDS.map(c=>{
    const f1 = c.image || '';
    const f2 = c.image_inside || '';
    return `
      <div class="card" data-num="${c.number}">
        <div class="thumbs">
          <img src="${f1}" alt="Frente ${c.title}" onerror="this.src='n.png'">
          <img src="${f2||'n.png'}" alt="Adentro ${c.title}" onerror="this.src='n.png'">
        </div>
        <div class="content">
          <div class="row">
            <span class="tag">#${c.number}</span>
            <span class="small">${fmtCRC(c.price||0)}</span>
          </div>
          <div class="title">${c.title||'(sin título)'}</div>
          <div class="small" style="color:#93a3b8">${(c.description||'').slice(0,90)}</div>
          <div class="actions">
            <button class="btn" data-action="edit"><i class="fa-regular fa-pen-to-square"></i> Editar</button>
            <button class="btn btn-red" data-action="delete"><i class="fa-regular fa-trash-can"></i> Eliminar</button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/* ====== Previews ====== */
const fileFront = $('#fileFront');
const fileInside = $('#fileInside');
const prevFront = $('#prevFront');
const prevInside = $('#prevInside');
const metaFront = $('#metaFront');
const metaInside = $('#metaInside');

function setPreview(elPreview, elMeta, file){
  if(!file){ elPreview.innerHTML = '<span class="meta">Arrastra o haz click para cargar</span>'; elMeta.textContent = 'Sin archivo'; return; }
  const url = URL.createObjectURL(file);
  elPreview.innerHTML = `<img src="${url}" alt="preview">`;
  elMeta.textContent = `${file.name} · ${(file.size/1024/1024).toFixed(2)} MB`;
}

fileFront.addEventListener('change', ()=> setPreview(prevFront, metaFront, fileFront.files[0]));
fileInside.addEventListener('change', ()=> setPreview(prevInside, metaInside, fileInside.files[0]));

/* ====== Crear/Actualizar tarjeta ====== */
const inputNumber = $('#number');
const inputTitle = $('#title');
const inputDesc = $('#desc');
const inputPrice = $('#price');

function resetForm(){
  inputNumber.value = '';
  inputTitle.value = '';
  inputDesc.value = '';
  inputPrice.value = '';
  fileFront.value = '';
  fileInside.value = '';
  setPreview(prevFront, metaFront, null);
  setPreview(prevInside, metaInside, null);
}

$('#resetBtn').addEventListener('click', resetForm);
$('#refreshBtn').addEventListener('click', async ()=>{ await loadCardsJson(); renderCards(); toast('Lista actualizada','ok'); });

/* Guardar / Actualizar flujo */
$('#saveBtn').addEventListener('click', async ()=>{
  try{
    const num = Number(inputNumber.value);
    if(!num || num<1) { toast('Número inválido','err'); return; }
    const title = inputTitle.value.trim();
    const description = inputDesc.value.trim();
    const price = Number(inputPrice.value||0);

    // Buscar si existe
    const idx = CARDS.findIndex(c=> Number(c.number)===num);
    const existing = idx>=0 ? CARDS[idx] : null;

    // Reglas de imágenes:
    // - Si es NUEVO: ambas imágenes requeridas
    // - Si es EDITAR: puedes omitir una/both para conservar las actuales
    const frontFile = fileFront.files[0] || null;
    const insideFile = fileInside.files[0] || null;

    if(!existing && (!frontFile || !insideFile)){
      toast('Para una tarjeta nueva, sube frente y adentro','err'); return;
    }

    // Cargar cards.json actual por si cambió
    await loadCardsJson();

    // Subir imágenes si corresponden
    let imageFrontUrl = existing?.image || '';
    let imageInsideUrl = existing?.image_inside || '';
    let shaFront = null, shaInside = null;

    // infiere rutas destino
    async function maybeUpload(file, kind){
      if(!file) return {url: (kind==='front'?imageFrontUrl:imageInsideUrl), sha: (kind==='front'?shaFront:shaInside)};
      const ext = fileExt(file);
      const path = `${GH.imagesDir}/card-${num}-${kind}.${ext}`;

      // ¿Existe? get sha
      const prev = await ghGet(path); const prevSha = prev?.sha || undefined;

      const dataURL = await readAsDataURL(file);
      const b64 = dataURLtoBase64(dataURL);
      await ghPut(path, b64, `admin: upload ${kind} for card #${num}`, prevSha);
      const rawUrl = `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/${path}`;
      return {url: rawUrl, sha: prevSha||null};
    }

    const upFront = await maybeUpload(frontFile, 'front');
    imageFrontUrl = upFront.url; shaFront = upFront.sha;

    const upInside = await maybeUpload(insideFile, 'inside');
    imageInsideUrl = upInside.url; shaInside = upInside.sha;

    // Construir objeto tarjeta
    const card = {
      number: num,
      title,
      description,
      price,
      image: imageFrontUrl,        // frente (compat con index actual)
      image_inside: imageInsideUrl // NUEVO
    };

    // Actualizar array
    if(existing) CARDS[idx] = card;
    else CARDS.push(card);

    CARDS.sort((a,b)=> (a.number||0)-(b.number||0));

    // Subir cards.json
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(CARDS,null,2))));
    await ghPut(GH.cardsJsonPath, content, `admin: update cards.json (#${num})`, cardsJsonSha||undefined);
    toast(existing ? 'Tarjeta actualizada' : 'Tarjeta creada','ok');

    // refrescar sha y lista
    await loadCardsJson();
    renderCards();
    // mantener formulario para seguir cargando más si quieres, o limpiar:
    // resetForm();

  }catch(err){
    console.error(err);
    toast('Error al guardar: '+err.message, 'err');
  }
});

/* ====== Editar / Eliminar en la lista ====== */
let deleteTarget = null;
const modal = $('#modal');
const modalInfo = $('#modalInfo');
$('#cancelDel').addEventListener('click', ()=>{ deleteTarget=null; modal.classList.remove('open'); });

$('#confirmDel').addEventListener('click', async ()=>{
  if(!deleteTarget) return;
  const num = deleteTarget.number;
  try{
    // Intentar borrar imágenes si están bajo nuestro directorio
    async function tryDeleteByUrl(url){
      if(!url) return;
      // Esperamos estructura raw.githubusercontent.com/{owner}/{repo}/{branch}/{path}
      const rawPrefix = `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/`;
      if(!url.startsWith(rawPrefix)) return; // no sabemos el sha de una ruta fuera
      const path = url.replace(rawPrefix,'');
      const meta = await ghGet(path);
      if(meta?.sha){
        await ghDelete(path, `admin: delete image for card #${num}`, meta.sha);
      }
    }
    await tryDeleteByUrl(deleteTarget.image);
    await tryDeleteByUrl(deleteTarget.image_inside);

    // Eliminar del array y subir JSON
    CARDS = CARDS.filter(c=> Number(c.number)!==Number(num));
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(CARDS,null,2))));
    await ghPut(GH.cardsJsonPath, content, `admin: remove card #${num}`, cardsJsonSha||undefined);

    toast(`Tarjeta #${num} eliminada`,'ok');
    modal.classList.remove('open');
    deleteTarget=null;
    await loadCardsJson();
    renderCards();
  }catch(err){
    console.error(err);
    toast('Error al eliminar: '+err.message,'err');
  }
});

$('#cardsList').addEventListener('click', (ev)=>{
  const cardEl = ev.target.closest('.card');
  if(!cardEl) return;
  const num = Number(cardEl.dataset.num);
  const card = CARDS.find(c=> Number(c.number)===num);
  if(!card) return;

  const act = ev.target.closest('button')?.dataset.action;
  if(act==='edit'){
    inputNumber.value = card.number;
    inputTitle.value = card.title||'';
    inputDesc.value = card.description||'';
    inputPrice.value = card.price||0;

    // clear file inputs; mostramos previews con URLs existentes
    fileFront.value = ''; fileInside.value = '';
    prevFront.innerHTML = card.image ? `<img src="${card.image}" alt="Frente">` : '<span class="meta">Sin frente</span>';
    metaFront.textContent = card.image ? card.image.split('/').pop() : 'Sin archivo';

    prevInside.innerHTML = card.image_inside ? `<img src="${card.image_inside}" alt="Adentro">` : '<span class="meta">Sin adentro</span>';
    metaInside.textContent = card.image_inside ? card.image_inside.split('/').pop() : 'Sin archivo';

    toast('Cargado en el formulario para editar','inf');
  }
  if(act==='delete'){
    deleteTarget = card;
    modalInfo.textContent = `#${card.number} · ${card.title}`;
    modal.classList.add('open');
  }
});

/* ====== Init ====== */
(async function init(){
  if(localStorage.getItem('cp_logged')==='1'){
    try{
      await loadCardsJson();
      renderCards();
      toast('cards.json cargado','ok');
    }catch(e){
      console.error(e);
      toast('No pude cargar cards.json (¿PAT correcto?)','err');
    }
  }
})();
</script>
</body>
</html>