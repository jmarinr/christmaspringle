<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Christmas Pringle ¬∑ Admin</title>
<link rel="icon" type="image/png" href="christmas-pringle-logo.png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
:root{
  --bg:#0f1720; --panel:#111a27; --panel-2:#0b1320;
  --text:#e8eef7; --muted:#9fb0c7;
  --green:#22c55e; --red:#ef4444; --gold:#ffd54f; --blue:#38bdf8; --violet:#c084fc;
  --border:rgba(255,255,255,.08);
  --shadow:0 10px 30px rgba(0,0,0,.35);

  --candy-red:#d32f2f; --candy-white:#fff;
  --wire:#0c1119;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  background: radial-gradient(1200px 800px at 10% -10%, #10233a 0 30%, #0b1829 60%, #08111f 100%);
  color:var(--text); overflow-x:hidden;
}

/* ===== Nieve sutil ===== */
.snow{position:fixed; inset:0; pointer-events:none; z-index:9999; overflow:hidden}
.flake{position:absolute; top:-10px; color:#fff; font-size:1.05em; opacity:.7;
  text-shadow:0 0 10px rgba(255,255,255,.65); animation:snowfall linear infinite}
@keyframes snowfall{
  0%{transform:translateY(-10vh) translateX(0) rotate(0); opacity:.0}
  12%{opacity:.8}
  90%{opacity:.8}
  100%{transform:translateY(100vh) translateX(-120px) rotate(-360deg); opacity:0}
}

/* ===== Topbar ===== */
.topbar{
  position:sticky; top:0; z-index:50;
  background:rgba(7,12,22,.9); backdrop-filter: blur(14px);
  border-bottom:1px solid var(--border); box-shadow: 0 2px 14px rgba(0,0,0,.25);
}
.topbar .inner{
  max-width:1200px; margin:0 auto; padding:14px 16px;
  display:flex; align-items:center; gap:12px; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:12px; font-weight:900}
.brand img{height:38px; width:auto; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.35)}
.tag{font-size:.82rem; padding:.25rem .55rem; border-radius:999px; background:#12243a; color:#9ecbff; border:1px solid var(--border)}
.pat-chip{display:flex; align-items:center; gap:8px; background:var(--panel); border:1px solid var(--border); padding:8px 10px; border-radius:999px; box-shadow:var(--shadow)}
.pat-chip code{letter-spacing:.2px}
.icon-btn{background:#12243a; color:#cfe6ff; border:1px solid var(--border); border-radius:10px; padding:8px 10px; cursor:pointer}
.icon-btn:hover{filter:brightness(1.08)}
.danger{background:#2a1316; color:#ffb0b8}

/* ===== Banda decorativa (guirnalda) ===== */
.bar-deco{position:relative; border-top:1px solid var(--border); border-bottom:1px solid var(--border); background:#0b1626}
.bar-deco .inner{max-width:1200px; margin:0 auto; padding:8px 16px; display:flex; gap:10px; align-items:center; color:#b9d7ff}
.bar-deco .inner span{opacity:.9}
.bar-deco .icons{margin-left:auto; display:flex; gap:10px; opacity:.9}

/* ===== Layout ===== */
.container{max-width:1200px; margin:18px auto; padding:0 16px; display:grid; grid-template-columns: 360px 1fr; gap:18px}
@media (max-width: 980px){ .container{grid-template-columns:1fr} }

.card{
  background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
  border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow);
}

/* ===== T√≠tulos con bastones sutiles ===== */
.h-title{
  font-weight:900; font-size:1.15rem; margin-bottom:10px; display:flex; align-items:center; gap:8px;
}
.h-title .candy{
  background: repeating-linear-gradient(45deg, var(--candy-white) 0 8px, var(--candy-red) 8px 16px);
  -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-stroke:1px rgba(255,255,255,.25);
}

/* ===== Formulario ===== */
.form{padding:16px}
.row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
.row-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px}
.row-1{display:grid; grid-template-columns: 1fr; gap:10px}
label{font-size:.88rem; opacity:.95}
input[type="text"], input[type="number"], textarea{
  width:100%; padding:10px 12px; color:var(--text);
  background: #0b1422; border:1px solid var(--border); border-radius:10px; outline:none;
}
textarea{min-height:88px; resize:vertical}
.small{font-size:.82rem; color:var(--muted)}
.btn{
  display:inline-flex; align-items:center; gap:8px;
  background:#17344f; color:#bfe0ff; border:1px solid var(--border);
  padding:10px 14px; border-radius:10px; cursor:pointer; text-decoration:none;
}
.btn.primary{background:#123a28; color:#9bf7c2}
.btn.warn{background:#3a2a12; color:#ffd79b}
.btn:hover{filter:brightness(1.08)}

/* ===== Uploader ===== */
.uploader{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
.uploader-item .drop{
  border:1px dashed rgba(255,255,255,.2); border-radius:12px; padding:10px; background:#0b1422;
}
.preview{
  width:100%; aspect-ratio:4/3; background: repeating-linear-gradient(45deg,#0f1b2b 0 10px,#0d1625 10px 20px);
  border-radius:10px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative;
}
.preview img{width:100%; height:100%; object-fit:contain}
.meta{margin-top:8px; color:var(--muted); font-size:.85rem}

/* ===== Lista tarjetas ===== */
.list{padding:16px}
.tools{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px}
.grid{display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));}
.item{border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#0b1422}
.thumb-row{display:grid; grid-template-columns:1fr 1fr; gap:6px; padding:6px; background:#0d1728}
.thumb-row img{width:100%; aspect-ratio:4/3; object-fit:cover; background:#09121f; border-radius:8px}
.item .body{padding:10px 12px}
.item h4{font-size:1rem}
.badges{display:flex; gap:8px; align-items:center; margin:6px 0}
.badge{font-size:.78rem; padding:.2rem .5rem; border-radius:999px; background:#10233a; color:#9ecbff; border:1px solid var(--border)}
.row-actions{display:flex; gap:8px; margin-top:8px}

/* ===== Toast ===== */
.toast{
  position:fixed; right:16px; bottom:16px; z-index:60;
  background:#0b1d31; color:#d9ecff; border:1px solid var(--border); box-shadow:var(--shadow);
  padding:12px 14px; border-radius:12px; display:none; min-width:220px;
}
.toast.show{display:block; animation:slideUp .25s ease-out}
@keyframes slideUp{from{transform:translateY(10px); opacity:.2}to{transform:translateY(0); opacity:1}}

/* ===== Modal ===== */
.modal{position:fixed; inset:0; background:rgba(2,6,14,.75); display:none; align-items:center; justify-content:center; z-index:55}
.modal.show{display:flex}
.modal .box{background:#0b1422; border:1px solid var(--border); border-radius:12px; padding:16px; width:min(480px,92vw); box-shadow:var(--shadow)}
.modal .box h3{margin-bottom:8px}
.modal .box .actions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}

/* ===== Spinner navide√±o ===== */
.spinner{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:80; background:rgba(2,6,14,.55); backdrop-filter: blur(2px)}
.spinner.show{display:flex}
.tree{width:94px; height:94px; position:relative; animation:spin 1.1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tree:before{content:"üéÑ"; font-size:70px; position:absolute; inset:0; display:grid; place-items:center; filter:drop-shadow(0 6px 16px rgba(0,0,0,.5))}
.tree:after{
  content:""; position:absolute; left:50%; top:0; transform:translateX(-50%);
  width:10px; height:10px; border-radius:50%; background:#ffd54f; box-shadow:
    0 16px 0 #ff5858, 0 32px 0 #31d67b, 0 48px 0 #3bb6ff, 0 64px 0 #ffd15a;
}

/* ===== Login con ornamentos ===== */
.login-wrap{
  max-width:480px; margin:10vh auto; padding:22px; border:1px solid var(--border);
  border-radius:16px; background:linear-gradient(180deg,#101b2b 0%, #0a1422 100%); box-shadow:var(--shadow); position:relative; overflow:hidden;
}
.login-wrap:before{
  content:""; position:absolute; inset:auto -40px -40px -40px; height:140px; background:
    radial-gradient(120px 60px at 10% 50%, rgba(255,255,255,.08), transparent 70%),
    radial-gradient(100px 50px at 30% 40%, rgba(255,255,255,.06), transparent 70%),
    radial-gradient(120px 50px at 70% 60%, rgba(255,255,255,.05), transparent 70%);
  pointer-events:none; filter:blur(1px)
}
.login-title{
  display:flex; align-items:center; gap:10px; font-size:1.35rem; font-weight:900; margin-bottom:8px
}
.login-title .icons{margin-left:auto; display:flex; gap:8px; opacity:.9}
.helper{font-size:.83rem; color:var(--muted); margin-top:6px}
.row-1{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px}
.toggle-eye{position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; opacity:.8}
.state-ok{color:#86efac}
.state-bad{color:#fda4af}
</style>
</head>
<body>
  <!-- Nieve -->
  <div class="snow" aria-hidden="true" id="snow"></div>

  <!-- Topbar -->
  <div class="topbar" id="topbar" style="display:none">
    <div class="inner">
      <div class="brand">
        <img src="christmas-pringle-logo.png" alt="Logo">
        <div>
          <div>Christmas Pringle ¬∑ Admin</div>
          <div class="tag">cards.json ¬∑ main</div>
        </div>
      </div>
      <div style="display:flex; align-items:center; gap:8px">
        <div class="pat-chip">
          <i class="fa-solid fa-key"></i>
          <code id="patMasked">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</code>
          <button class="icon-btn" id="copyPat" title="Copiar PAT"><i class="fa-regular fa-copy"></i></button>
        </div>
        <button class="icon-btn danger" id="logout"><i class="fa-solid fa-right-from-bracket"></i> Salir</button>
      </div>
    </div>
    <div class="bar-deco">
      <div class="inner">
        <span>üéÅ Gesti√≥n de tarjetas</span>
        <div class="icons"><span>üîî</span><span>‚ùÑÔ∏è</span><span>üéÑ</span><span>‚ú®</span></div>
      </div>
    </div>
  </div>

  <!-- Login -->
  <section id="loginView" class="login-wrap">
    <div class="login-title">
      <span>Acceso a administraci√≥n</span>
      <div class="icons"><span>üéÑ</span><span>‚ùÑÔ∏è</span><span>üîî</span></div>
    </div>
    <p class="helper">Ingresa con tu usuario y PAT de GitHub para publicar tarjetas.</p>

    <div class="row-1" style="position:relative">
      <label>Usuario</label>
      <input type="text" id="user" placeholder="Usuario" autocomplete="username">
    </div>
    <div class="row-1" style="position:relative">
      <label>Contrase√±a</label>
      <input type="password" id="pass" placeholder="Contrase√±a" autocomplete="current-password">
      <span class="toggle-eye" id="togglePass"><i class="fa-regular fa-eye"></i></span>
    </div>

    <div class="row-1">
      <label>GitHub Personal Access Token (PAT)</label>
      <input type="text" id="pat" placeholder="ghp_xxx..." autocomplete="off">
      <p class="helper">Se guarda localmente (clave: <code>cp_pat</code>). Necesita permiso <b>repo</b>.</p>
    </div>

    <div class="row-1" style="margin-top:10px">
      <button class="btn primary" id="loginBtn"><i class="fa-solid fa-unlock-keyhole"></i> Ingresar</button>
    </div>
  </section>

  <!-- App -->
  <main id="app" style="display:none">
    <section class="container">
      <!-- Formulario -->
      <div class="card form">
        <div class="h-title"><span class="candy">Crear / Editar tarjeta</span> <span>‚ú®</span></div>

        <div class="row">
          <div>
            <label>N√∫mero</label>
            <input type="number" id="number" min="1" placeholder="Ej: 1">
          </div>
          <div>
            <label>Precio (‚Ç° CRC)</label>
            <input type="number" id="price" min="0" step="1" placeholder="Ej: 3500">
          </div>
        </div>

        <div class="row">
          <div>
            <label>T√≠tulo</label>
            <input type="text" id="title" placeholder="Ej: √Årbol de Navidad">
          </div>
          <div>
            <label>Descripci√≥n</label>
            <input type="text" id="desc" placeholder="Breve descripci√≥n">
          </div>
        </div>

        <div class="uploader" style="margin-top:6px">
          <!-- Frente -->
          <div class="uploader-item">
            <label style="font-weight:700;display:block;margin-bottom:.35rem">Foto frente</label>
            <div class="drop" id="dropFront">
              <input type="file" id="fileFront" accept="image/*">
              <div class="preview" id="prevFront"><span class="meta">Arrastra o haz click para cargar</span></div>
              <div class="meta small" id="metaFront">Sin archivo</div>
            </div>
          </div>
          <!-- Adentro -->
          <div class="uploader-item">
            <label style="font-weight:700;display:block;margin-bottom:.35rem">Foto adentro</label>
            <div class="drop" id="dropInside">
              <input type="file" id="fileInside" accept="image/*">
              <div class="preview" id="prevInside"><span class="meta">Arrastra o haz click para cargar</span></div>
              <div class="meta small" id="metaInside">Sin archivo</div>
            </div>
          </div>
        </div>

        <div class="tools" style="margin-top:10px">
          <button class="btn primary" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Guardar/Actualizar</button>
          <button class="btn warn" id="clearBtn"><i class="fa-regular fa-trash-can"></i> Limpiar</button>
        </div>
        <div class="small" id="statusLine">Listo.</div>
      </div>

      <!-- Lista -->
      <div class="card list">
        <div class="h-title"><span class="candy">Tarjetas guardadas</span> <span>üéÅ</span></div>
        <div class="tools">
          <button class="btn" id="reloadBtn"><i class="fa-solid fa-rotate-right"></i> Recargar</button>
          <span class="small">Estado: <span id="syncState" class="state-ok">sin cambios</span></span>
        </div>
        <div id="grid" class="grid"></div>
      </div>
    </section>
  </main>

  <!-- Modal confirm -->
  <div class="modal" id="confirmModal" aria-hidden="true">
    <div class="box">
      <h3>¬øEliminar tarjeta?</h3>
      <p>Esto borrar√° el registro y sus im√°genes (si est√°n en el repo).</p>
      <div class="actions">
        <button class="btn" id="cancelDel">Cancelar</button>
        <button class="btn danger" id="acceptDel"><i class="fa-solid fa-trash"></i> Eliminar</button>
      </div>
    </div>
  </div>

  <!-- Spinner -->
  <div class="spinner" id="spinner"><div class="tree"></div></div>

  <!-- Toast -->
  <div class="toast" id="toast"><span id="toastMsg">Listo</span></div>

<script>
/* ============ Nieve sutil ============ */
const snowEl = document.getElementById('snow');
function flake(){
  const f=document.createElement('div'); f.className='flake';
  f.textContent=['‚ùÑ','‚ùÖ','‚ùÜ'][Math.floor(Math.random()*3)];
  f.style.left=(Math.random()*100)+'%';
  f.style.animationDuration=(Math.random()*4+7)+'s';
  f.style.opacity=(Math.random()*.4+.35).toFixed(2);
  f.style.fontSize=(Math.random()*.6+0.9).toFixed(2)+'em';
  snowEl.appendChild(f);
  setTimeout(()=>f.remove(),10000);
}
let snowTimer=setInterval(flake,420);
for(let i=0;i<14;i++) setTimeout(flake, i*180);

/* ============ Utils ============ */
const $ = sel => document.querySelector(sel);
function show(el, v){ el.style.display = v ? '' : 'none'; }
function toast(msg){ const t=$('#toast'), m=$('#toastMsg'); m.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2000); }
function spin(v){ $('#spinner').classList.toggle('show', v); }
function fileExt(file){
  const name = (file?.name||'').toLowerCase();
  const ext = name.includes('.') ? name.split('.').pop() : (file?.type||'image/jpeg').split('/').pop();
  return (ext||'jpg').replace(/[^a-z0-9]/g,'') || 'jpg';
}
function readAsDataURL(file){return new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file);});}
function dataURLtoBase64(dataURL){ return dataURL.split(',')[1]; }
function maskPat(p){ if(!p) return '‚Äî'; return p.length>10 ? p.slice(0,4)+'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'+p.slice(-3) : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'; }

/* ============ Auth ============ */
const LOGIN = { user:'patripringle', pass:'SoyPatri1978' };
function isLogged(){ return localStorage.getItem('cp_logged')==='1'; }
function setLogged(v){ localStorage.setItem('cp_logged', v?'1':'0'); }
function getPAT(){ return localStorage.getItem('cp_pat')||''; }
function setPAT(p){ localStorage.setItem('cp_pat', p||''); updatePatChip(); }
function updatePatChip(){ $('#patMasked').textContent = maskPat( getPAT() ); }

/* ============ GitHub ============ */
const GH = {
  owner:'jmarinr', repo:'christmaspringle', branch:'main',
  cardsPath:'cards.json', imagesDir:'images/cards'
};
async function ghReq(path, method='GET', body=null, etag=null){
  const headers={ 'Accept':'application/vnd.github+json', 'Authorization':`Bearer ${getPAT()}` };
  if(body) headers['Content-Type']='application/json';
  if(etag) headers['If-None-Match']=etag;
  const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${encodeURIComponent(path)}`;
  return fetch(url,{method, headers, body: body?JSON.stringify(body):undefined});
}
async function ghGet(path, etag=null){
  const res=await ghReq(path,'GET',null,etag);
  if(res.status===304) return {notModified:true, etag:res.headers.get('ETag')};
  if(!res.ok) return null;
  const json=await res.json(); json.etag=res.headers.get('ETag'); return json;
}
async function ghPut(path,b64,message,sha){
  const body={message, content:b64, branch:GH.branch}; if(sha) body.sha=sha;
  const res=await ghReq(path,'PUT',body); if(!res.ok) throw new Error('PUT '+res.status); return res.json();
}
async function ghDelete(path,message,sha){
  const body={message, sha, branch:GH.branch};
  const res=await ghReq(path,'DELETE',body); if(!res.ok) throw new Error('DELETE '+res.status); return res.json();
}

/* ============ Estado / Sync ============ */
let CARDS=[], CARDS_SHA=null, CARDS_ETAG=null;
const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('cp-admin-sync') : null;
bc?.addEventListener('message', ev=>{ if(ev?.data==='refresh'){ loadCards(true); } });

async function loadCards(silent=false){
  try{
    if(!silent) spin(true);
    const meta = await ghGet(GH.cardsPath, CARDS_ETAG);
    if(meta?.notModified){ setSync('sin cambios (304)', true); return; }
    if(!meta){ CARDS=[]; CARDS_SHA=null; CARDS_ETAG=null; renderList(); return; }
    const content = atob(meta.content||'');
    CARDS = JSON.parse(content||'[]'); CARDS_SHA=meta.sha||null; CARDS_ETAG=meta.etag||null;
    renderList(); setSync('actualizado', true);
  }catch(e){ console.error(e); setSync('error', false);
  }finally{ if(!silent) spin(false); }
}
function setSync(msg, ok){ const el=$('#syncState'); el.textContent=msg; el.className= ok?'state-ok':'state-bad'; }

/* Poll ETag */
setInterval(async ()=>{
  if(!isLogged()) return;
  try{ const head=await ghGet(GH.cardsPath, CARDS_ETAG); if(head && !head.notModified){ await loadCards(true); } }catch(e){}
},8000);

/* ============ Render Lista ============ */
function renderList(){
  const grid=$('#grid');
  if(!Array.isArray(CARDS)||!CARDS.length){ grid.innerHTML='<div class="small" style="opacity:.8">No hay tarjetas a√∫n.</div>'; return; }
  const sorted=[...CARDS].sort((a,b)=>(a.number||0)-(b.number||0));
  grid.innerHTML = sorted.map(c=>{
    const f1=c.image||'n.png', f2=c.image_inside||'n.png';
    const hasInside=!!c.image_inside;
    return `
      <div class="item" data-num="${c.number}">
        <div class="thumb-row">
          <img src="${f1}" alt="Frente ${c.title}" loading="lazy">
          <img src="${f2}" alt="Adentro ${c.title}" loading="lazy">
        </div>
        <div class="body">
          <h4>#${c.number} ¬∑ ${c.title||''}</h4>
          <div class="badges">
            <span class="badge">‚Ç°${Math.round(c.price||0).toLocaleString('es-CR')}</span>
            ${hasInside?'<span class="badge">con interior</span>':'<span class="badge" style="opacity:.6">sin interior</span>'}
          </div>
          <div class="row-actions">
            <button class="btn" onclick="fillForm(${c.number})"><i class="fa-regular fa-pen-to-square"></i> Editar</button>
            <button class="btn danger" onclick="askDelete(${c.number})"><i class="fa-regular fa-trash-can"></i> Eliminar</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

/* ============ Form Helpers ============ */
function clearForm(){
  $('#number').value=''; $('#price').value=''; $('#title').value=''; $('#desc').value='';
  $('#fileFront').value=''; $('#fileInside').value='';
  $('#prevFront').innerHTML='<span class="meta">Arrastra o haz click para cargar</span>'; $('#metaFront').textContent='Sin archivo';
  $('#prevInside').innerHTML='<span class="meta">Arrastra o haz click para cargar</span>'; $('#metaInside').textContent='Sin archivo';
  $('#statusLine').textContent='Listo.';
}
function fillForm(n){
  const c=CARDS.find(x=>Number(x.number)===Number(n)); if(!c) return;
  $('#number').value=c.number||''; $('#price').value=c.price||''; $('#title').value=c.title||''; $('#desc').value=c.description||'';
  if(c.image){ $('#prevFront').innerHTML=`<img src="${c.image}" alt="Frente">`; $('#metaFront').textContent=c.image.split('/').pop(); }
  else{ $('#prevFront').innerHTML='<span class="meta">Arrastra o haz click para cargar</span>'; $('#metaFront').textContent='Sin archivo'; }
  if(c.image_inside){ $('#prevInside').innerHTML=`<img src="${c.image_inside}" alt="Adentro">`; $('#metaInside').textContent=c.image_inside.split('/').pop(); }
  else{ $('#prevInside').innerHTML='<span class="meta">Arrastra o haz click para cargar</span>'; $('#metaInside').textContent='Sin archivo'; }
  $('#statusLine').textContent='Editando #'+c.number;
}

/* Previews */
const fileFront=$('#fileFront'), fileInside=$('#fileInside');
fileFront?.addEventListener('change', ()=>{
  const f=fileFront.files[0];
  if(!f){ $('#prevFront').innerHTML='<span class="meta">Arrastra o haz click para cargar</span>'; $('#metaFront').textContent='Sin archivo'; return; }
  const url=URL.createObjectURL(f); $('#prevFront').innerHTML=`<img src="${url}" alt="Frente">`; $('#metaFront').textContent=`${f.name} ¬∑ ${(f.size/1024/1024).toFixed(2)} MB`;
});
fileInside?.addEventListener('change', ()=>{
  const f=fileInside.files[0];
  if(!f){ $('#prevInside').innerHTML='<span class="meta">Arrastra o haz click para cargar</span>'; $('#metaInside').textContent='Sin archivo'; return; }
  const url=URL.createObjectURL(f); $('#prevInside').innerHTML=`<img src="${url}" alt="Adentro">`; $('#metaInside').textContent=`${f.name} ¬∑ ${(f.size/1024/1024).toFixed(2)} MB`;
});

/* ============ Save / Update ============ */
function rawPrefix(){ return `https://raw.githubusercontent.com/${GH.owner}/${GH.repo}/${GH.branch}/`; }
async function tryDeleteByRawUrl(url){
  if(!url) return; const prefix=rawPrefix(); if(!url.startsWith(prefix)) return;
  const path=decodeURIComponent(url.replace(prefix,'')); const meta=await ghGet(path); if(meta?.sha) await ghDelete(path,'admin: delete image',meta.sha);
}
async function uploadImageIfNeeded(file, cardNumber, kind){
  if(!file) return null;
  const ext=fileExt(file), path=`${GH.imagesDir}/card-${cardNumber}-${kind}.${ext}`;
  const dataURL=await readAsDataURL(file); const b64=dataURLtoBase64(dataURL);
  await ghPut(path,b64,`admin: upload ${kind} for card #${cardNumber}`,undefined);
  return `${rawPrefix()}${path}`;
}
async function saveCard(){
  const num=Number($('#number').value), price=Number($('#price').value||0);
  const title=($('#title').value||'').trim(), desc=($('#desc').value||'').trim();
  if(!num || !title){ toast('Completa n√∫mero y t√≠tulo'); return; }

  const existing=CARDS.find(c=>Number(c.number)===num)||null;
  const frontFile=fileFront?.files?.[0]||null, insideFile=fileInside?.files?.[0]||null;

  try{
    spin(true); $('#statusLine').textContent='Subiendo‚Ä¶';
    let imageFrontUrl=existing?.image||'', imageInsideUrl=existing?.image_inside||'';
    if(frontFile){ if(existing?.image) await tryDeleteByRawUrl(existing.image); imageFrontUrl=await uploadImageIfNeeded(frontFile,num,'front'); }
    if(insideFile){ if(existing?.image_inside) await tryDeleteByRawUrl(existing.image_inside); imageInsideUrl=await uploadImageIfNeeded(insideFile,num,'inside'); }

    const newCard={ number:num, title, description:desc, price, image:imageFrontUrl||existing?.image||'', image_inside:imageInsideUrl||existing?.image_inside||'' };

    let next=Array.isArray(CARDS)?[...CARDS]:[]; const i=next.findIndex(c=>Number(c.number)===num);
    if(i>=0) next[i]=newCard; else next.push(newCard);

    const content=btoa(JSON.stringify(next,null,2));
    const put=await ghPut(GH.cardsPath,content,`admin: save card #${num}`,CARDS_SHA||undefined);

    CARDS=next; CARDS_SHA=put?.content?.sha||CARDS_SHA; CARDS_ETAG=null;
    renderList(); clearForm(); $('#statusLine').textContent='Guardado'; toast('Tarjeta guardada ‚úÖ');
    bc?.postMessage('refresh');
  }catch(e){ console.error(e); toast('Error al guardar'); $('#statusLine').textContent='Error';
  }finally{ spin(false); }
}

/* ============ Delete ============ */
let pendingDelete=null;
function askDelete(num){ pendingDelete=Number(num); $('#confirmModal').classList.add('show'); }
$('#cancelDel').addEventListener('click', ()=>{ pendingDelete=null; $('#confirmModal').classList.remove('show'); });
$('#acceptDel').addEventListener('click', async ()=>{
  if(!pendingDelete){ $('#confirmModal').classList.remove('show'); return; }
  try{
    spin(true);
    const num=pendingDelete; const card=CARDS.find(c=>Number(c.number)===num); if(!card) throw new Error('No existe');
    await tryDeleteByRawUrl(card.image); await tryDeleteByRawUrl(card.image_inside);

    const next=CARDS.filter(c=>Number(c.number)!==num);
    const content=btoa(JSON.stringify(next,null,2));
    const put=await ghPut(GH.cardsPath,content,`admin: delete card #${num}`,CARDS_SHA||undefined);
    CARDS=next; CARDS_SHA=put?.content?.sha||CARDS_SHA; CARDS_ETAG=null;
    renderList(); toast('Tarjeta eliminada üóëÔ∏è'); bc?.postMessage('refresh');
  }catch(e){ console.error(e); toast('Error al eliminar');
  }finally{ spin(false); pendingDelete=null; $('#confirmModal').classList.remove('show'); }
});

/* ============ Login Flow ============ */
function updateUI(){
  if(isLogged()){
    show($('#loginView'),false); show($('#topbar'),true); show($('#app'),true);
    updatePatChip(); loadCards();
  }else{
    show($('#loginView'),true); show($('#topbar'),false); show($('#app'),false);
  }
}
$('#togglePass').addEventListener('click', ()=>{
  const p=$('#pass'); p.type=(p.type==='password'?'text':'password');
  $('#togglePass').innerHTML = `<i class="fa-regular fa-${p.type==='password'?'eye':'eye-slash'}"></i>`;
});
$('#loginBtn').addEventListener('click', ()=>{
  const u=$('#user').value.trim(), p=$('#pass').value.trim(), pat=$('#pat').value.trim();
  if(u==='patripringle' && p==='SoyPatri1978'){
    setLogged(true); if(pat) setPAT(pat); updateUI(); toast('Bienvenido üëã');
  }else{ toast('Credenciales inv√°lidas'); }
});
$('#copyPat').addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(getPAT()); toast('PAT copiado'); }catch(e){ toast('No se pudo copiar'); }});
$('#logout').addEventListener('click', ()=>{ setLogged(false); setPAT(''); CARDS=[]; CARDS_SHA=null; CARDS_ETAG=null; updateUI(); });

/* ============ Bindings ============ */
$('#saveBtn').addEventListener('click', saveCard);
$('#clearBtn').addEventListener('click', clearForm);
$('#reloadBtn').addEventListener('click', ()=> loadCards());

;['dropFront','dropInside'].forEach(id=>{
  const box=$('#'+id); const input=box.querySelector('input[type="file"]');
  box.addEventListener('click', ()=> input.click());
  ;['dragenter','dragover'].forEach(evt=> box.addEventListener(evt, e=>{ e.preventDefault(); box.style.borderColor='#38bdf8'; }));
  ;['dragleave','drop'].forEach(evt=> box.addEventListener(evt, e=>{ e.preventDefault(); box.style.borderColor='rgba(255,255,255,.2)'; }));
  box.addEventListener('drop', e=>{ const f=e.dataTransfer.files?.[0]; if(!f) return; input.files=e.dataTransfer.files; input.dispatchEvent(new Event('change')); });
});

/* ============ Init ============ */
updateUI();
</script>
</body>
</html>